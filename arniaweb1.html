<!DOCTYPE html>
<html lang="it">
<head>
  <!-- Set di caratteri per la codifica del documento -->
  <meta charset="UTF-8">
  
  <!-- Titolo della pagina web che appare nella scheda del browser -->
  <title>Web BLE ESP32</title>
  
  <!-- Meta tag per la gestione della larghezza del viewport sui dispositivi mobili -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <style>
    /* Stili per la pagina */
    body {
      font-family: Arial, sans-serif; /* Font per il testo */
      padding: 20px; /* Padding per il corpo della pagina */
      background: #f2f2f2; /* Colore di sfondo della pagina */
      color: #333; /* Colore del testo */
      max-width: 600px; /* Larghezza massima per la pagina */
      margin: auto; /* Centra il contenuto */
    }

    h1 {
      text-align: center; /* Allinea il titolo al centro */
      color: #005fa3; /* Colore del titolo */
    }

    button {
      padding: 10px 20px; /* Spaziatura interna per i bottoni */
      margin: 5px; /* Margine tra i bottoni */
      font-size: 16px; /* Dimensione del font dei bottoni */
      border: none; /* Rimuove il bordo dai bottoni */
      border-radius: 5px; /* Arrotonda gli angoli del bottone */
      background: #007bff; /* Colore di sfondo del bottone */
      color: white; /* Colore del testo nei bottoni */
      cursor: pointer; /* Cambia il cursore quando il bottone √® hoverato */
    }

    button:hover {
      background: #0056b3; /* Cambia il colore del bottone quando √® hoverato */
    }

    input[type="number"] {
      padding: 10px; /* Spaziatura interna del campo input */
      font-size: 16px; /* Dimensione del font dell'input */
      width: 60%; /* Larghezza del campo input */
      margin: 5px 0; /* Margine tra l'input e gli altri elementi */
    }

    /* Stili per lo stato e la risposta */
    #status, #response {
      margin-top: 20px; /* Distanza superiore */
      font-weight: bold; /* Rende il testo grassetto */
    }

    /* Controlli extra per l'utente */
    #extraControls {
      margin-top: 20px; /* Distanza superiore */
    }

    /* Stili per lo storico dei comandi */
    #commandHistory {
      margin-top: 30px; /* Distanza superiore */
      background: #fff; /* Sfondo bianco per la sezione */
      padding: 15px; /* Padding interno */
      border-radius: 8px; /* Arrotonda gli angoli della sezione */
    }

    #commandHistory ul {
      list-style: none; /* Rimuove i punti elenco dalla lista */
      padding-left: 0; /* Rimuove il padding a sinistra */
    }

    #commandHistory li {
      border-bottom: 1px solid #ccc; /* Bordo inferiore per ogni elemento della lista */
      padding: 5px 0; /* Padding sopra e sotto ogni elemento della lista */
    }
  </style>
</head>
<body>
  <!-- Titolo della webapp -->
  <h1>Web BLE ESP32</h1>

  <!-- Sezione comandi iniziali -->
  <div id="initialCommands">
    <button onclick="connect()">üîå Connetti ESP32</button> <!-- Pulsante per connettersi all'ESP32 -->
    <button onclick="sendCommand('tara')">üìè Invia "tara"</button> <!-- Pulsante per inviare il comando "tara" -->
    <button onclick="sendCommand('calibrazione')">‚öñÔ∏è Invia "calibrazione"</button> <!-- Pulsante per inviare il comando "calibrazione" -->
  </div>

  <!-- Paragrafo per visualizzare lo stato della connessione -->
  <p id="status">Stato: ‚ùå Disconnesso</p>

  <!-- Paragrafo per visualizzare la risposta ricevuta -->
  <p id="response">Risposta:</p>

  <!-- Contenitore dinamico per i controlli extra (Si/No o campo peso) -->
  <div id="extraControls"></div>

  <!-- Storico comandi inviati -->
  <div id="commandHistory">
    <h3>üìã Comandi Inviati</h3>
    <ul id="historyList"></ul> <!-- Lista per visualizzare la cronologia dei comandi -->
    <button onclick="clearHistory()" style="background: #dc3545;">üóëÔ∏è Cancella cronologia</button> <!-- Pulsante per cancellare la cronologia -->
  </div>

  <script>
    let txChar, rxChar; // Variabili per le caratteristiche BLE (TX e RX)

    // Funzione per connettersi all'ESP32 via Bluetooth
    async function connect() {
      try {
        // Richiede il dispositivo BLE (ESP32)
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'ESP32' }],
          optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e'] // Servizio specifico dell'ESP32
        });

        const server = await device.gatt.connect(); // Connessione al server BLE
        const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e'); // Ottieni il servizio BLE

        // Ottieni le caratteristiche TX e RX
        txChar = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');
        rxChar = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');

        // Avvia le notifiche per la caratteristica TX (risposta dall'ESP32)
        await txChar.startNotifications();
        txChar.addEventListener('characteristicvaluechanged', handleResponse);

        // Aggiorna lo stato di connessione
        document.getElementById('status').innerText = "Stato: ‚úÖ Connesso";
      } catch (e) {
        console.error("Errore di connessione:", e); // Log degli errori
        alert("Connessione fallita");
      }
    }

    // Funzione per inviare comandi all'ESP32
    async function sendCommand(command) {
      if (!rxChar) return alert("Non connesso"); // Verifica se √® stabilita la connessione
      const data = new TextEncoder().encode(command); // Codifica il comando in formato binario
      await rxChar.writeValue(data); // Invia il comando all'ESP32
      console.log("Inviato comando:", command); // Log del comando inviato
      saveCommand(command); // Salva il comando nel localStorage
    }

    // Funzione per gestire la risposta dall'ESP32
    function handleResponse(event) {
      const response = new TextDecoder().decode(event.target.value); // Decodifica la risposta dall'ESP32
      document.getElementById('response').innerText = "Risposta: " + response; // Visualizza la risposta
      console.log("ESP32 dice:", response); // Log della risposta

      // Gestisce i controlli dinamici in base alla risposta ricevuta
      const controls = document.getElementById('extraControls');
      controls.innerHTML = ""; // Rimuove i controlli precedenti

      if (response.toLowerCase() === "sei sicuro?") {
        // Mostra i pulsanti Si/No per la conferma di "tara"
        controls.innerHTML = `
          <button onclick="sendCommand('si')">‚úÖ Si</button>
          <button onclick="sendCommand('no')">‚ùå No</button>
        `;
        toggleInitialCommands(false); // Nasconde i comandi iniziali

      } else if (response.toLowerCase() === "dammi il peso") {
        // Mostra il campo per inserire il peso
        controls.innerHTML = `
          <input type="number" id="pesoInput" placeholder="Inserisci peso in grammi...">
          <button onclick="inviaPeso()">üì§ Invia peso</button>
        `;
        toggleInitialCommands(false); // Nasconde i comandi iniziali

      } else {
        toggleInitialCommands(true); // Mostra i comandi iniziali
        controls.innerHTML = "";
      }
    }

    // Funzione per inviare il peso all'ESP32
    function inviaPeso() {
      const peso = document.getElementById("pesoInput").value; // Ottieni il valore del peso
      if (!peso || isNaN(peso)) { // Verifica che il peso sia valido
        alert("Inserisci un numero valido");
        return;
      }
      sendCommand(peso); // Invia il peso come comando
    }

    // Funzione per mostrare/nascondere i comandi iniziali
    function toggleInitialCommands(show) {
      document.getElementById("initialCommands").style.display = show ? "block" : "none";
    }

    // Funzione per salvare i comandi inviati nel localStorage
    function saveCommand(cmd) {
      let history = JSON.parse(localStorage.getItem("bleCommands")) || []; // Carica la cronologia dal localStorage
      history.push({ command: cmd, time: new Date().toLocaleString() }); // Aggiungi il nuovo comando
      localStorage.setItem("bleCommands", JSON.stringify(history)); // Salva nel localStorage
      renderHistory(); // Rende visibile la cronologia aggiornata
    }

    // Funzione per visualizzare la cronologia dei comandi
    function renderHistory() {
      const list = document.getElementById("historyList");
      list.innerHTML = ""; // Pulisce la lista
